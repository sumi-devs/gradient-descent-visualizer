# Plotly.js Development Guide for Claude

This file contains important learnings and patterns for working with the Plotly.js codebase.

## Adding New Layout Properties

When adding a new property to `layout.hoverlabel` (or similar nested layout objects), you need to modify **multiple files** in a specific order:

### 1. Layout-Level Schema Definition
**File**: `/src/components/fx/layout_attributes.js`
```javascript
hoverlabel: {
    // ... existing properties
    newproperty: {
        valType: 'boolean',  // or 'string', 'number', etc.
        dflt: true,          // default value
        editType: 'none',    // or 'calc', 'plot', etc.
        description: 'Description of what this property does.'
    }
}
```

### 2. Trace-Level Schema Definition
**File**: `/src/components/fx/attributes.js`
```javascript
hoverlabel: {
    // ... existing properties
    newproperty: extendFlat({}, hoverLabelAttrs.newproperty, {arrayOk: true}),
}
```
**Critical**: Trace-level attributes extend layout attributes and add `arrayOk: true` to support per-trace arrays.

### 3. Property Coercion
**File**: `/src/components/fx/hoverlabel_defaults.js`
```javascript
coerce('hoverlabel.newproperty', opts.newproperty);
```
**Pattern**: Use `opts.newproperty` as the default to inherit from layout-level settings.

### 4. Implementation Logic
**File**: `/src/components/fx/hover.js` (or relevant rendering file)
- Access the property via `fullLayout.hoverlabel.newproperty`
- Pass to rendering functions as needed
- Implement the actual functionality

## Common Pitfalls

### Missing Trace-Level Attributes
**Error**: `Cannot read properties of undefined (reading 'arrayOk')`
**Cause**: Property defined in `layout_attributes.js` but missing from `attributes.js`
**Solution**: Add the property to both files

### Missing Coercion
**Symptom**: Property not available at runtime even when set in input
**Cause**: Property not coerced in `hoverlabel_defaults.js`
**Solution**: Add coercion line following the established pattern

### Incorrect Function Parameters
**Issue**: Passing entire objects (like `fullLayout`) to rendering functions
**Best Practice**: Extract only the needed values and pass minimal parameters

## File Structure Overview

```
src/components/fx/
├── layout_attributes.js    # Layout-level schema definitions
├── attributes.js          # Trace-level schema (extends layout, adds arrayOk)
├── layout_defaults.js     # Calls hoverlabel_defaults for layout
├── hoverlabel_defaults.js # Coerces hoverlabel properties (both layout & trace)
├── defaults.js           # Calls hoverlabel_defaults for traces
└── hover.js              # Main hover rendering logic
```

## Key Patterns

- **Schema inheritance**: Trace attributes extend layout attributes
- **Default cascading**: `opts.property` provides layout-level default for trace coercion
- **Minimal parameters**: Pass specific values, not entire objects to functions
- **Three-file pattern**: `layout_attributes.js` → `attributes.js` → `hoverlabel_defaults.js`

## Example Workflow

1. Define property in `layout_attributes.js`
2. Extend in `attributes.js` with `arrayOk: true`
3. Add coercion in `hoverlabel_defaults.js`
4. Implement logic in relevant rendering file
5. Test with HTML file using built library

This pattern applies to most Plotly.js layout property additions, not just hoverlabel.