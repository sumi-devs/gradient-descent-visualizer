# Beginner's Guide to Plotly.js

This guide provides an overview of the Plotly.js codebase architecture, core principles, and best practices for contributors looking to extend or modify the library.

## Codebase Structure

Plotly.js is organized into several key directories:

- **src/**: Plotly.js source code
  - **components/**: Reusable UI components (annotations, colorbar, legend, etc.)
  - **constants/**: Constant values used throughout the codebase
  - **lib/**: Utility functions and helpers
  - **plots/**: Core plotting infrastructure (axes, layout logic)
  - **traces/**: Individual chart type implementations (scatter, bar, etc.)
  - **transforms/**: Data transformation modules
  - **plot_api/**: API endpoints that users interact with
- **dist/**: Distribution files (pre-built bundles)
- **lib/**: CommonJS require-able modules
- **test/**: Test files (jasmine and image tests)

## Core Architecture Principles

### Module Registry System

The central organizing concept in Plotly.js is the registry (`src/registry.js`), which manages all modules:

- Each chart type (scatter, bar, etc.) is a separate module
- UI components (legend, colorbar, etc.) are modular
- Base plotting systems (cartesian, geo, etc.) are extensible
- All modules are registered with the system at initialization time

This modular design allows for selective bundling, clear separation of concerns, and extensibility.

### Component Structure

Each trace module follows a consistent pattern with these key methods:

1. **supplyDefaults**: Fills in default values for trace attributes
2. **calc**: Converts input data into "calculated" data for rendering
3. **plot**: Draws the trace on screen
4. **style**: Handles visual styling of the trace
5. **hoverPoints**: Logic for determining hover behavior
6. **selectPoints**: Logic for handling data selection

## Rendering Process

When a chart is created, Plotly.js follows these steps:

### 1. Initialization
When users call `Plotly.newPlot()`, the process begins in `plot_api.js:_doPlot()` by:
- Setting up the plot container
- Initializing event handlers

### 2. Data Processing
- **Supply Defaults**: The `supplyDefaults` functions fill in missing values in user input
- **Calculate Data**: The `calc` functions convert input data to calculated data optimized for rendering
- **Link Data**: Traces are linked to their calculated data representation

### 3. Plot Framework
- Create SVG container and layers
- Set up WebGL canvases if needed

### 4. Draw Components
- Framework components are drawn first
- Margin-pushing elements are processed
- Axes are calculated and margins adjusted
- Traces are drawn according to their z-order
- Annotations, legends, and other overlays are added

### 5. Add Interactivity
- Event listeners for hover, click, and drag
- Modebar (toolbar) initialization

## Adding New Features

When adding a new feature to Plotly.js, follow these guidelines:

### For New Trace Types

1. **Study Existing Traces**: Look at similar trace implementations to understand patterns
2. **Implement Core Methods**: Create the essential methods:
   - `supplyDefaults`
   - `calc`
   - `plot`
   - `style`
   - `hoverPoints` (if supporting hover)
   - `selectPoints` (if supporting selection)
3. **Define Attributes**: Create an attributes schema that documents all properties
4. **Register Your Module**: Add your trace to the registry
5. **Add Tests**: Create both unit tests and visual tests

### For New Components

1. **Keep it Modular**: Design components to be self-contained
2. **Follow the Component Pattern**: Implement the standard lifecycle methods
3. **Document Attributes**: Create a comprehensive attribute schema
4. **Consider Performance**: Optimize for reusability and efficiency

## Key Rules to Follow

1. **Respect the Module System**: Work within the modular architecture
2. **Maintain API Compatibility**: Don't break existing functionality
3. **Optimize Calculations**: `calc` methods should be efficient and not repeated unnecessarily
4. **Separate Concerns**: Keep data processing separate from rendering
5. **Document Everything**: Add JSDoc comments and update attribute schemas
6. **Add Tests**: All new features should have unit and visual tests

## Common Pitfalls

### Performance Issues

1. **Avoid Redundant Calculations**: Don't recalculate data that hasn't changed
2. **Optimize Large Dataset Handling**: Use WebGL for large datasets
3. **Batch DOM Updates**: Minimize reflows by batching DOM changes

### Rendering Problems

1. **WebGL Context Loss**: Handle WebGL context loss properly for GL-based traces
2. **Text Measurement Issues**: Text may need to be measured after initial rendering
3. **Responsive Layout Challenges**: Be careful with dimension calculations for responsive layouts

### API Design Mistakes

1. **Inconsistent Attribute Naming**: Follow existing naming patterns
2. **Missing Default Values**: Always provide sensible defaults
3. **Incomplete Validation**: Ensure all user input is properly validated

## Debugging Tips

1. **Use the Registry**: Explore modules through `Plotly.Registry`
2. **Inspect Calculated Data**: Check `gd.calcdata` to see the computed representation
3. **Examine Full Layout**: `gd._fullLayout` contains all layout properties with defaults
4. **Test Incrementally**: Test each component of your implementation separately

## Resources for Further Learning

- Review the trace implementations in `src/traces/`
- Study the core plotting logic in `src/plots/plots.js`
- Explore the API implementation in `src/plot_api/plot_api.js`
- Read the attribute schemas to understand configuration options

By following these guidelines, you'll be able to contribute effectively to Plotly.js while maintaining its architecture and performance characteristics.